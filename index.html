<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Book Your Service</title>
<link rel="stylesheet" href="main.css">
<script src="https://cdn.jsdelivr.net/npm/lucide-static@0.16.29/font/lucide.js"></script>
</head>
<body>
<div class="container" style="max-width:900px">
<h1>BOOK YOUR SERVICE</h1>

<div class="section">
<div class="section-title">Available Products</div>
<div class="grid grid-3" id="productsGrid"></div>
</div>

<div class="section" id="cartSection" style="display:none">
<div class="section-title">Your Cart</div>
<div id="cartItems"></div>
<div style="text-align:right;margin-top:15px">
<strong>Subtotal: ₹<span id="cartSubtotal">0</span></strong>
</div>
</div>

<div class="section">
<div class="section-title">Have a Coupon?</div>
<div style="display:flex;gap:10px">
<input type="text" id="couponCode" placeholder="Enter code" style="margin:0">
<button onclick="applyCoupon()" class="primary" style="width:auto">Apply</button>
</div>
<div id="couponMsg" style="margin-top:10px"></div>
</div>

<div class="section">
<div class="section-title">Booking Details</div>
<label>Full Name *</label>
<input type="text" id="name" required>
<label>Phone Number *</label>
<input type="tel" id="phone" required>
<label>Service Type *</label>
<select id="serviceType">
<option value="Tour & Travel">Tour & Travel</option>
<option value="Car Rental">Car Rental</option>
<option value="Photography">Photography Session</option>
<option value="Event Planning">Event Planning</option>
<option value="Course">Online Course</option>
<option value="Product">Product Purchase</option>
<option value="Consultation">Consultation</option>
<option value="Other">Other Service</option>
</select>
</div>

<div class="section">
<div class="section-title">Are You a Content Creator?</div>
<p style="color:#888;margin-bottom:15px">Do you create content on YouTube, Instagram, or other platforms? Join our creator program!</p>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer">
<input type="checkbox" id="isCreator" onchange="toggleCreatorSection()" style="width:auto;margin:0">
<span>Yes, I'm a content creator and want to join the program</span>
</label>
<div id="creatorDetails" class="hidden" style="margin-top:20px;padding:20px;background:#0a0a0a;border:1px solid #4a9eff">
<p style="color:#4a9eff;margin-bottom:15px">★ Benefits: Get your own coupon code, earn commission on referrals, and exclusive perks!</p>
<label>Platform(s)</label>
<input type="text" id="creatorPlatforms" placeholder="e.g., YouTube, Instagram, TikTok">
<label>Channel/Profile Name</label>
<input type="text" id="creatorHandle" placeholder="Your channel or profile name">
<label>Subscriber/Follower Count (Approximate)</label>
<input type="number" id="creatorFollowers" placeholder="e.g., 10000">
<p style="color:#888;font-size:0.85em;margin-top:10px">
Note: Admin will review and approve your application. You'll receive your creator code via phone/email.
</p>
</div>
</div>

<div class="section">
<div class="section-title">Price Summary</div>
<div style="display:flex;justify-content:space-between;margin-bottom:10px">
<span>Subtotal:</span>
<span>₹<span id="displaySubtotal">0</span></span>
</div>
<div style="display:flex;justify-content:space-between;margin-bottom:10px;color:#0f0" id="discountRow" class="hidden">
<span>Discount (<span id="discountPercent">0</span>%):</span>
<span>-₹<span id="displayDiscount">0</span></span>
</div>
<div style="display:flex;justify-content:space-between;font-size:1.5em;font-weight:700;border-top:1px solid #333;padding-top:10px">
<span>Total:</span>
<span>₹<span id="displayTotal">0</span></span>
</div>
</div>

<button onclick="submitBooking()" id="bookBtn">COMPLETE BOOKING</button>
</div>

<div id="loadingOverlay" class="loading-overlay hidden">
<div class="loading"></div>
</div>

<script>
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwHJf1DA9D_itesCVkTtb0TeGFAorqnQ5hR1PdBDUVhXLVkk55IDW5hD2sLJPsPHsWkLQ/exec';
const products = [
  {id: 1, name: 'Product 1', price: 5000, desc: 'Premium service package with basic features'},
  {id: 2, name: 'Product 2', price: 10000, desc: 'Advanced service package with extended features'},
  {id: 3, name: 'Product 3', price: 15000, desc: 'Ultimate service package with all premium features'}
];

let cart = [];
let appliedCoupon = null;

function init() {
  renderProducts();
  updateCart();
}

function renderProducts() {
  const grid = document.getElementById('productsGrid');
  grid.innerHTML = products.map(p => `
    <div class="product-card">
      <h3>${p.name}</h3>
      <div class="product-price">₹${p.price}</div>
      <p style="color:#888;font-size:0.85em;margin-bottom:15px">${p.desc}</p>
      <button onclick="addToCart(${p.id})" class="secondary" style="width:100%">Add to Cart</button>
    </div>
  `).join('');
}

function addToCart(id) {
  const product = products.find(p => p.id === id);
  const existing = cart.find(c => c.id === id);
  
  if (existing) {
    existing.quantity++;
  } else {
    cart.push({...product, quantity: 1});
  }
  
  updateCart();
  showToast('Added to cart', 'success');
}

function removeFromCart(id) {
  cart = cart.filter(c => c.id !== id);
  updateCart();
}

function updateQuantity(id, delta) {
  const item = cart.find(c => c.id === id);
  if (item) {
    item.quantity += delta;
    if (item.quantity <= 0) {
      removeFromCart(id);
    } else {
      updateCart();
    }
  }
}

function updateCart() {
  const cartSection = document.getElementById('cartSection');
  const cartItems = document.getElementById('cartItems');
  
  if (cart.length === 0) {
    cartSection.style.display = 'none';
    updatePriceSummary();
    return;
  }
  
  cartSection.style.display = 'block';
  cartItems.innerHTML = cart.map(item => `
    <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #222;padding:10px 0">
      <div>
        <strong>${item.name}</strong><br>
        <span style="color:#888">₹${item.price} each</span>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <button onclick="updateQuantity(${item.id}, -1)" class="secondary" style="width:30px;padding:5px">-</button>
        <span>${item.quantity}</span>
        <button onclick="updateQuantity(${item.id}, 1)" class="secondary" style="width:30px;padding:5px">+</button>
        <button onclick="removeFromCart(${item.id})" class="danger" style="width:auto;padding:5px 10px">Remove</button>
      </div>
    </div>
  `).join('');
  
  updatePriceSummary();
}

function updatePriceSummary() {
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const discount = appliedCoupon ? (subtotal * appliedCoupon.discount / 100) : 0;
  const total = subtotal - discount;
  
  document.getElementById('cartSubtotal').textContent = subtotal;
  document.getElementById('displaySubtotal').textContent = subtotal;
  document.getElementById('displayDiscount').textContent = discount.toFixed(0);
  document.getElementById('discountPercent').textContent = appliedCoupon ? appliedCoupon.discount : 0;
  document.getElementById('displayTotal').textContent = total.toFixed(0);
  
  if (appliedCoupon) {
    document.getElementById('discountRow').classList.remove('hidden');
  } else {
    document.getElementById('discountRow').classList.add('hidden');
  }
}

function applyCoupon() {
  const code = document.getElementById('couponCode').value.trim().toUpperCase();
  if (!code) {
    showToast('Enter a coupon code', 'error');
    return;
  }
  
  showLoading();
  fetch(`${WEB_APP_URL}?action=validateCoupon&code=${code}`)
    .then(r => r.json())
    .then(d => {
      hideLoading();
      const msg = document.getElementById('couponMsg');
      if (d.valid) {
        appliedCoupon = {code: code, discount: d.discount, creatorPhone: d.creatorPhone};
        msg.innerHTML = `<div style="color:#0f0">✓ ${d.discount}% discount applied!</div>`;
        updatePriceSummary();
        showToast('Coupon applied', 'success');
      } else {
        msg.innerHTML = `<div style="color:#f44">Invalid or expired code</div>`;
        appliedCoupon = null;
        updatePriceSummary();
        showToast('Invalid coupon', 'error');
      }
    })
    .catch(err => {
      hideLoading();
      showToast('Error validating coupon', 'error');
    });
}

function toggleCreatorSection() {
  const checkbox = document.getElementById('isCreator');
  const details = document.getElementById('creatorDetails');
  if (checkbox.checked) {
    details.classList.remove('hidden');
  } else {
    details.classList.add('hidden');
  }
}

function submitBooking() {
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const service = document.getElementById('serviceType').value;
  
  if (!name || !phone) {
    showToast('Fill all required fields', 'error');
    return;
  }
  
  if (cart.length === 0) {
    showToast('Add items to cart', 'error');
    return;
  }
  
  const isCreator = document.getElementById('isCreator').checked;
  let creatorData = {};
  
  if (isCreator) {
    const platforms = document.getElementById('creatorPlatforms').value.trim();
    const handle = document.getElementById('creatorHandle').value.trim();
    const followers = document.getElementById('creatorFollowers').value.trim();
    
    if (!platforms || !handle) {
      showToast('Fill creator details (platform and handle required)', 'error');
      return;
    }
    
    creatorData = {
      isCreator: true,
      platforms: platforms,
      handle: handle,
      followers: followers || '0'
    };
  }
  
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const discount = appliedCoupon ? appliedCoupon.discount : 0;
  const final = subtotal - (subtotal * discount / 100);
  
  const data = {
    action: 'submitBooking',
    name, phone, service,
    quantity: cart.reduce((sum, item) => sum + item.quantity, 0),
    basePrice: subtotal,
    discount: discount,
    finalPrice: final,
    couponCode: appliedCoupon ? appliedCoupon.code : '',
    ...creatorData
  };
  
  showLoading();
  fetch(WEB_APP_URL, {
    method: 'POST',
    body: JSON.stringify(data)
  })
  .then(r => r.json())
  .then(d => {
    hideLoading();
    if (d.success) {
      let msg = 'Booking confirmed!';
      if (isCreator) {
        msg += ' Your creator application has been submitted for review.';
      }
      showToast(msg, 'success');
      setTimeout(() => location.reload(), 2000);
    } else {
      showToast('Error: ' + (d.error || 'Unknown error'), 'error');
    }
  })
  .catch(err => {
    hideLoading();
    showToast('Network error', 'error');
  });
}

function showLoading() {
  document.getElementById('loadingOverlay').classList.remove('hidden');
  document.getElementById('bookBtn').disabled = true;
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.add('hidden');
  document.getElementById('bookBtn').disabled = false;
}

function showToast(msg, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

init();
</script>
</body>
</html>